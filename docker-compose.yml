# @author Rodrigo Navas
version: "3.8"

services:
  # # Crea un proxy inverso
  serverproxy-rueda:
    # Imagen base para generar el contenedor
    image: jwilder/nginx-proxy
    # Nombre asignado al contenedor
    container_name: serverproxy-rueda
    # Puertos abiertos para acceder al contenedor
    ports:
      - 81:80
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
    networks:
      - desafio3-servidor
    privileged: true

  rueda-db:
    # La imagen del contenedor se construye sobre una adecuando las necesidades
    image: mariadb:10.5.8
    # Nombre asignado al contenedor
    container_name: rueda-db
    # Red para el conjunto de contenedores
    ports:
        - 3306:3306
    #La ruta del volumen debe apuntar a la carpeta que contiene los datos de la base de datos
    volumes:
        - database:/var/lib/mysql
    #Variables de entorno  para el contenedor
    environment:
        - MYSQL_ROOT_PASSWORD=Chubaca2020
        - MYSQL_USER=rodrigo
        - MYSQL_PASSWORD=Chubaca2020
    networks:
        - desafio3-servidor
    depends_on:
        - serverproxy-rueda

  rueda-servidor:
    # La imagen del contenedor se construye sobre una adecuando las necesidades
    build: .
    # Nombre asignado al contenedor
    container_name: rueda-servidor
    # Variable de entorno para el contendor
    environment:
      # Esta ruta debe estar incluida en el fichero hosts del anfitrión
      - VIRTUAL_HOST=server-ruedas.com
    networks:
        - desafio3-servidor
    # Para la versión de desarrollo se mapea la carpeta con una local
    volumes:
        - .:/var/www/html/
    depends_on:
        - rueda-db
        - serverproxy-rueda

networks:
    desafio3-servidor:
        driver: bridge
volumes:
    database:
